<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>New York Ski Mountains Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        header {
            padding: 12px 16px;
            background: #0f172a;
            color: white;
        }

        header h1 {
            margin: 0;
            font-size: 1.25rem;
        }

        header p {
            margin: 4px 0 0;
            font-size: 0.9rem;
            color: #cbd5f5;
        }


    </style>
</head>

<body>
    <header>
        <h1>New York Ski Mountains</h1>
        <p>Interactive map of ski areas across New York State</p>
    </header>
    <div id="layout">
        <div id="map"></div>
        <div id="userside">
            <input id="loc" placeholder="Enter a location (e.g., Syracuse, NY)">
            <button id="go">Find closest</button>
            <div id="closest"></div>
        </div>
    </div>

    <script>
        const map = L.map("map").setView([42.9, -75.5], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        setTimeout(() => map.invalidateSize(), 200);
        Papa.parse("ski_mtn_ny.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
                const rows = results.data;

                rows.forEach(row => {
                    const name = row.name;
                    const lat = parseFloat(row.latitude);
                    const lon = parseFloat(row.longitude);
                    const acres = row.skiable_area_acres;
                    const popupContent = `
            <strong>${name}</strong><br>
            Skiable area: ${acres}`;
                    L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(popupContent);
                });
            }
        });
        let userMarker;
        const redIcon = L.divIcon({
            className: "",
            html: `<div style="width:14px;height:14px;border-radius:50%;
    background:red;border:2px solid white;"></div>`,
            iconSize: [14, 14],
            iconAnchor: [7, 7]
        });

        async function geocode(q) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
            const data = await (await fetch(url)).json();
            if (!data.length) throw Error("Location not found");
            return { lat: +data[0].lat, lon: +data[0].lon };
        }

        function miles(lat1, lon1, lat2, lon2) {
            const R = 3958.8, toRad = d => d * Math.PI / 180;
            const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
            return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        document.getElementById("go").onclick = async () => {
            const q = document.getElementById("loc").value.trim();
            if (!q) return;
            const { lat, lon } = await geocode(q);

            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([lat, lon], { icon: redIcon }).addTo(map);
            map.setView([lat, lon], 9);

            const top5 = resorts
                .map(r => ({ ...r, d: miles(lat, lon, r.lat, r.lon) }))
                .sort((a, b) => a.d - b.d)
                .slice(0, 5);

            document.getElementById("closest").innerHTML =
                "<h3>5 Closest Resorts</h3><ol>" +
                top5.map(r => `<li>${r.name} â€” ${r.d.toFixed(1)} mi</li>`).join("") +
                "</ol>";
            setTimeout(() => map.invalidateSize(), 200);

        };
    </script>
</body>

</html>